# 分支名
$:
  push:
    - imports: https://cnb.cool/iceolive/private-config/-/blob/main/github.yml
      stages:
        - git push --progress https://${GITHUB_TOKEN}@github.com/wmz46/${CNB_REPO_NAME_LOWERCASE} HEAD:${CNB_BRANCH}
        - git push --tags https://${GITHUB_TOKEN}@github.com/wmz46/${CNB_REPO_NAME_LOWERCASE}
  # 事件名
  tag_push:
    - docker:
        image: node:18
      imports: https://cnb.cool/iceolive/private-config/-/blob/main/smtp.yml
      # 要执行的任务
      stages:
        - yarn
        - echo "\nalways-auth=true" >> .npmrc
        - echo "\n//npm.cnb.cool/iceolive/wmz46/pub-npm/-/packages/:_authToken=$CNB_TOKEN" >> .npmrc
        - yarn release
        - name: notify
          image:  drillster/drone-email
          settings:
            host: $smtp_host
            username: $smtp_username
            password: $smtp_password
            from: $smtp_from
            recipients: $smtp_recipients
            subject: 成功发布${CNB_REPO_NAME_LOWERCASE}@${CNB_BRANCH}
            body: 成功发布${CNB_REPO_NAME_LOWERCASE}@${CNB_BRANCH}
      failStages:
        - name: notify
          image:  drillster/drone-email
          settings:
            host: $smtp_host
            username: $smtp_username
            password: $smtp_password
            from: $smtp_from
            recipients: $smtp_recipients
            subject: 发布${CNB_REPO_NAME_LOWERCASE}@${CNB_BRANCH}失败
            body: 发布${CNB_REPO_NAME_LOWERCASE}@${CNB_BRANCH}失败 <br> ${CNB_BUILD_FAILED_STAGE_NAME} <br> ${CNB_BUILD_FAILED_MSG} <br> ${CNB_BUILD_WEB_URL}